# Review Engine V2 - Technical Specification

## 1. Overview
The Review Engine V2 is a comprehensive system designed to handle product and seller reviews with a strong focus on verification, multi-dimensional ratings, and fraud detection. It aims to build trust within the marketplace by distinguishing verified purchases and filtering out spam or fake reviews.

## 2. Data Model & Schema

### 2.1 Review (Core)
```typescript
interface Review {
  id: string;
  product_id: string;
  store_id: string; // Denormalized for query performance
  user_id: string;
  order_id: string | null; // Null if open review (not verified purchase)
  
  // Rating Dimensions
  rating_overall: number; // 1-5
  rating_details?: {
    item_condition: number; // 1-5
    description_accuracy: number; // 1-5
    shipping_speed: number; // 1-5
    seller_communication: number; // 1-5
  };
  
  // Content
  comment: string;
  tags: string[]; // e.g., ["Fast Shipping", "Item as described"]
  media: {
    url: string;
    type: 'image' | 'video';
    thumbnail_url?: string;
  }[];
  
  // Metadata
  is_verified_purchase: boolean;
  is_anonymous: boolean;
  display_name: string; // 'User123' or 'John D.'
  
  // Engagement
  helpful_count: number;
  report_count: number;
  
  // Reply
  seller_reply?: {
    text: string;
    replied_at: Date;
  };

  // Status
  status: 'pending' | 'published' | 'hidden' | 'rejected';
  
  created_at: Date;
  updated_at: Date;
}
```

### 2.2 Review Moderation Queue
```typescript
interface ReviewFlag {
  id: string;
  review_id: string;
  reporter_id: string; // User ID or 'system' for AI flags
  reason: 'spam' | 'fake' | 'abusive' | 'irrelevant' | 'competitor_attack';
  description?: string;
  status: 'pending' | 'resolved' | 'dismissed';
  created_at: Date;
}

interface ReviewActionLog {
  id: string;
  review_id: string;
  moderator_id: string;
  action: 'approve' | 'reject' | 'hide';
  reason_code: string;
  note?: string;
  created_at: Date;
}
```

---

## 3. Workflow & Logic

### 3.1 Verification Logic
- **Verified Review:** Can only be submitted via the "My Orders" -> "Review Item" flow. System checks `order_id` status is `delivered`.
- **Open Review:** Submitted via product page. Marked as `is_verified_purchase = false`. Restricted rate limit (e.g., 1 per product per 30 days).

### 3.2 Anti-Fraud & Moderation System (Automated)
1.  **Velocity Check:** Flag if >3 reviews from same IP/Device within 1 hour.
2.  **Pattern Matching:** Flag if text is < 5 chars or contains banned keywords.
3.  **Cross-Ref Check:** Flag if reviewer is also a seller of similar goods (Competitor Check).
4.  **AI Analysis (Async):**
    -   `detectFakeReview(text)`: NLP score for generic/bot-like phrasing.
    -   `imageReverseSearch(media)`: Check if image exists elsewhere in DB (duplicate).

### 3.3 Seller Response
- Sellers receive notification of new reviews defined as < 4 stars.
- Sellers can reply once per review. Replying locks the thread (no multi-level nested comments to prevent arguments).

---

## 4. API Endpoints

### Public / User
- `POST /api/v2/products/{id}/reviews`: Submit review. Payload includes optional `order_id` for verification.
- `GET /api/v2/products/{id}/reviews`: List.
    - Info: `verified_only=true`, `has_media=true`.
    - Sort: `most_helpful`, `newest`, `rating_desc`.
- `POST /api/v2/reviews/{id}/helpful`: Toggle helpful vote.
- `POST /api/v2/reviews/{id}/report`: Flag a review.

### Seller
- `POST /api/v2/seller/reviews/{id}/reply`: Seller official response.
- `GET /api/v2/seller/reviews/summary`: Aggregated stats for dashboard.

### Admin
- `GET /api/v2/admin/moderation/reviews`: Queue of flagged items.
- `PATCH /api/v2/admin/moderation/reviews/{id}`: Approve/Reject action.

---

## 5. UI/UX Requirements

### 5.1 Review Summary Component
- **Header:** "4.8 (1,240 Reviews)".
- **Filters:** Buttons for "5 Star (80%)", "4 Star (10%)", "With Photo", "Verified".
- **AI Summary:** "Pros: Great quality, Fast delivery. Cons: Box slightly damaged." (Generated by LLM).

### 5.2 Review Card
- **User Info:** Avatar, Name, Badge ("Verified Buyer").
- **Tags:** Bubbles for "Good Packaging", "Fast".
- **Media:** Lightbox gallery for images.
- **Helpful:** Thumb icon with count.
- **Seller Reply:** Creating a distinct background box nested review.

---

## 6. AI & Automation Hooks
1.  **AI Summarization:** Cron job runs nightly to aggregate reviews for a product and generate/update the "Pros/Cons" summary displayed on the product page.
2.  **Smart Reminders:** Auto-schedule email 3 days after `order.delivered`. If no review after 7 days, send one reminder with "Earn 5 Coins" incentive.
3.  **Sentiment Alert:** If a product receives >3 negative reviews in 24 hours, alert the Seller via Push Notification.

## 7. Metrics
- **Verification Rate:** Target > 80% of total reviews.
- **Helpfulness:** Average helpful votes per review.
- **Moderation Speed:** 95% of flagged reviews handled within 24h.
