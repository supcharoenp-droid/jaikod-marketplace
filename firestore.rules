rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // Helper Functions
    // ==========================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if user is admin (Alternate check via custom claims if available, fallback to doc)
    // For now keeping simple doc lookup as defined above.

    // Verify that seller_id exists in users collection (only for writes)
    function sellerExistsForWrite(sellerId) {
      return exists(/databases/$(database)/documents/users/$(sellerId));
    }
    
    // Validate that seller_id matches authenticated user (for new listings)
    function isValidSeller() {
      return request.resource.data.seller_id == request.auth.uid;
    }
    
    // ==========================================
    // Users Collection
    // ==========================================
    match /users/{userId} {
      // ✅ Anyone can read user profiles (for public shop pages)
      allow read: if true;
      
      // ✅ Users can create their own profile OR system can create placeholders
      allow create: if (isAuthenticated() && request.auth.uid == userId) ||
                      (request.resource.data.get('isPlaceholder', false) == true);
      
      // ✅ Users can update their own profile, admins can update anyone
      allow update: if isOwner(userId) || isAdmin();
      
      // ✅ Only admins can delete users
      allow delete: if isAdmin();

      // ✅ Users can manage their own wishlist (subcollection)
      match /wishlist/{wishlistId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ==========================================
    // Listings Collection (New System)
    // ==========================================
    match /listings/{listingId} {
      // ✅ Anyone can read ANY listing (public marketplace)
      allow read: if true;
      
      // ✅ Authenticated users can create listings
      // seller_id MUST be their own UID
      allow create: if isAuthenticated() && 
                      isValidSeller() &&
                      request.resource.data.seller_id is string &&
                      request.resource.data.title is string;
      
      // ✅ Update rules:
      // - Owner or admin can update anything
      // - Anyone can update ONLY stats fields (views, favorites, shares)
      allow update: if (isAuthenticated() && request.auth.uid == resource.data.seller_id) || 
                      isAdmin() ||
                      // Allow public stats updates (views, favorites, shares only)
                      (request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['stats', 'updated_at']));
      
      // ✅ Only owner or admin can delete
      allow delete: if (isAuthenticated() && request.auth.uid == resource.data.seller_id) || isAdmin();
    }
    
    // ==========================================
    // Products Collection (Legacy System)
    // ==========================================
    match /products/{productId} {
      // ✅ Anyone can read ANY product (public marketplace)
      allow read: if true;
      
      // ✅ Authenticated users can create products
      allow create: if isAuthenticated() && 
                      isValidSeller() &&
                      request.resource.data.seller_id is string;
      
      // ✅ Only owner or admin can update
      allow update: if (isAuthenticated() && request.auth.uid == resource.data.seller_id) || isAdmin();
      
      // ✅ Only owner or admin can delete
      allow delete: if (isAuthenticated() && request.auth.uid == resource.data.seller_id) || isAdmin();
    }
    
    // ==========================================
    // Conversations Collection
    // ==========================================
    match /conversations/{conversationId} {
      // ✅ Only participants can read
      allow read: if isAuthenticated() && 
                    request.auth.uid in resource.data.participants;
      
      // ✅ Authenticated users can create conversations
      allow create: if isAuthenticated() && 
                      request.auth.uid in request.resource.data.participants;
      
      // ✅ Only participants can update
      allow update: if isAuthenticated() && 
                      request.auth.uid in resource.data.participants;
      
      // ✅ Only participants can delete
      allow delete: if isAuthenticated() && 
                      request.auth.uid in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                      request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        allow create: if isAuthenticated() && 
                        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        allow update, delete: if isAuthenticated() && 
                                request.auth.uid == resource.data.senderId;
      }
    }
    
    // ==========================================
    // Reviews Collection
    // ==========================================
    match /reviews/{reviewId} {
      // ✅ Anyone can read reviews (public)
      allow read: if true;
      
      // ✅ Authenticated users can create reviews
      allow create: if isAuthenticated() && 
                      request.resource.data.reviewerId == request.auth.uid;
      
      // ✅ Only reviewer can update their own review
      allow update: if isAuthenticated() && request.auth.uid == resource.data.reviewerId;
      
      // ✅ Only reviewer or admin can delete
      allow delete: if (isAuthenticated() && request.auth.uid == resource.data.reviewerId) || isAdmin();
    }
    
    // ==========================================
    // Orders Collection
    // ==========================================
    match /orders/{orderId} {
      // ✅ Only buyer, seller, or admin can read
      allow read: if isAuthenticated() && 
                    (request.auth.uid == resource.data.buyer_id || 
                     request.auth.uid == resource.data.seller_id || 
                     isAdmin());
      
      // ✅ Authenticated buyers can create orders
      allow create: if isAuthenticated() && 
                      request.resource.data.buyer_id == request.auth.uid;
      
      // ✅ Buyer, seller, or admin can update
      allow update: if isAuthenticated() && 
                      (request.auth.uid == resource.data.buyer_id || 
                       request.auth.uid == resource.data.seller_id || 
                       isAdmin());
      
      // ✅ Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // Data Quality Reports Collection
    // ==========================================
    match /data_quality_reports/{reportId} {
      // ✅ Anyone authenticated can read their own reports, admins can read all
      allow read: if isAuthenticated() && 
                    (request.auth.uid == resource.data.reported_by || isAdmin());
      
      // ✅ Authenticated users can create reports
      allow create: if isAuthenticated();
      
      // ✅ Only admins can update/delete reports
      allow update, delete: if isAdmin();
    }
    
    // ==========================================
    // Search History Collection
    // ==========================================
    match /searchHistory/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==========================================
    // User Preferences Collection
    // ==========================================
    match /userPreferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==========================================
    // Analytics Collection
    // ==========================================
    match /analytics/{document=**} {
      // ✅ Admins can read/write all analytics
      allow read, write: if isAdmin();
    }
    
    // ==========================================
    // Search Analytics Collection (camelCase - legacy)
    // ==========================================
    match /searchAnalytics/{docId} {
      // ✅ Anyone can write search analytics (tracking for both logged in and anonymous users)
      allow create: if true;
      // ✅ Only admins can read/update/delete
      allow read, update, delete: if isAdmin();
    }
    
    // ==========================================
    // Search Analytics Collection (snake_case - new)
    // ==========================================
    match /search_analytics/{docId} {
      // ✅ Anyone can write search analytics (tracking for both logged in and anonymous users)
      allow create: if true;
      // ✅ Only admins can read/update/delete
      allow read, update, delete: if isAdmin();
    }
    
    // ==========================================
    // Search Suggestions Collection
    // ==========================================
    match /search_suggestions/{docId} {
      // ✅ Anyone can read search suggestions (for autocomplete)
      allow read: if true;
      // ✅ Only system (via Cloud Functions) or admins can write
      allow write: if isAdmin();
    }
    
    // ==========================================
    // User Behavior Tracking
    // ==========================================
    match /userBehavior/{userId} {
      // ✅ Users can track their own behavior
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    match /userBehavior/{userId}/{document=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==========================================
    // Wishlist Collection
    // ==========================================
    match /wishlists/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==========================================
    // Counters Collection (For Listing Codes)
    // ==========================================
    match /counters/{counterId} {
      // ✅ Anyone authenticated can read counters
      allow read: if isAuthenticated();
      
      // ✅ Authenticated users can update counters (for listing code generation)
      allow write: if isAuthenticated();
    }
    
    // ==========================================
    // Categories & Static Data (Public Read)
    // ==========================================
    match /categories/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ==========================================
    // PDPA Consent Logs
    // ==========================================
    match /pdpaLogs/{logId} {
      // ✅ Anyone can create PDPA consent logs (for cookie consent tracking)
      allow create: if true;
      // ✅ Only admins can read/update/delete
      allow read, update, delete: if isAdmin();
    }
    
    // ==========================================
    // Notifications Collection
    // ==========================================
    // ==========================================
    // Notifications Collection
    // ==========================================
    match /notifications/{notificationId} {
      // ✅ Users can read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // ✅ Users can create notifications (sending to self or others)
      // For simplicity/robustness in client-side triggering, allow auth users to create.
      // In strict mode, we might check if userId == request.auth.uid (to self) or specific logic.
      allow create: if isAuthenticated();
      
      // ✅ Only recipient can update (mark as read) or delete
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ==========================================
    // JaiStar Transactions Collection
    // ==========================================
    match /transactions/{txId} {
      // ✅ Users can read their own transactions
      allow read: if isAuthenticated() && 
                    (resource.data.user_id == request.auth.uid || 
                     resource.data.from_user_id == request.auth.uid ||
                     resource.data.to_user_id == request.auth.uid);
      
      // ✅ System creates transactions (via Cloud Functions ideally)
      // For now, allow auth users to create
      allow create: if isAuthenticated() && 
                      request.resource.data.user_id == request.auth.uid;
      
      // ❌ No one can update/delete transactions (immutable ledger)
      allow update, delete: if false;
    }
    
    // ==========================================
    // JaiStar User Balances
    // ==========================================
    match /jaistar_balances/{userId} {
      // ✅ Users can read their own balance
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // ✅ Only system (Cloud Functions) should write - for security
      // Temporarily allow auth users during development
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==========================================
    // Chat Rooms (Active System)
    // ==========================================
    match /chat_rooms/{roomId} {
      // ✅ Participants can read chat metadata
      allow read: if isAuthenticated() && 
                    request.auth.uid in resource.data.participants;
      
      // ✅ Auth users can create new chats
      allow create: if isAuthenticated() && 
                      request.auth.uid in request.resource.data.participants;
      
      // ✅ Participants can update chat (mark as read, update last message)
      allow update: if isAuthenticated() && 
                      request.auth.uid in resource.data.participants;
      
      // ❌ No delete (archive via update)
      allow delete: if false;
    }

    // ==========================================
    // Chat Messages (Active System)
    // ==========================================
    match /chat_messages/{messageId} {
      // ✅ Participants can read messages
      allow read: if isAuthenticated() && 
                    request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(resource.data.room_id)).data.participants;
        
      // ✅ Participants can send messages
      allow create: if isAuthenticated() && 
                      request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(request.resource.data.room_id)).data.participants &&
                      request.resource.data.sender_id == request.auth.uid;
      
      // ✅ Participants can update messages (edit own, or mark as read/accept offer)
      allow update: if isAuthenticated() && 
                      request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(resource.data.room_id)).data.participants;
      
      // ❌ No delete messages
      allow delete: if false;
    }
    
    // ==========================================
    // AI Feedback Collection (for learning)
    // ==========================================
    match /ai_feedback/{feedbackId} {
      // ✅ Admins can read all feedback
      allow read: if isAdmin();
      
      // ✅ Anyone can submit feedback (for AI improvement)
      allow create: if true;
      
      // ❌ No updates/deletes
      allow update, delete: if isAdmin();
    }
    
    // ==========================================
    // User Locations (for distance calculation)
    // ==========================================
    match /user_locations/{userId} {
      // ✅ Users can manage their own location
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==========================================
    // Seller Verification Requests
    // ==========================================
    match /verification_requests/{requestId} {
      // ✅ Users can read their own requests
      allow read: if isAuthenticated() && 
                    (resource.data.user_id == request.auth.uid || isAdmin());
      
      // ✅ Users can create verification requests
      allow create: if isAuthenticated() && 
                      request.resource.data.user_id == request.auth.uid;
      
      // ✅ Only admins can update (approve/reject)
      allow update: if isAdmin();
      
      // ❌ No delete
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // Report/Flag Collection
    // ==========================================
    match /reports/{reportId} {
      // ✅ Admins can read all reports
      allow read: if isAdmin() || 
                    (isAuthenticated() && resource.data.reporter_id == request.auth.uid);
      
      // ✅ Anyone authenticated can create reports
      allow create: if isAuthenticated() && 
                      request.resource.data.reporter_id == request.auth.uid;
      
      // ✅ Only admins can update (resolve)
      allow update, delete: if isAdmin();
    }
    
    // ==========================================
    // System Config (Read-only for clients)
    // ==========================================
    match /system_config/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ==========================================
    // Shop System Collections
    // ==========================================
    
    // Shops
    match /shops/{shopId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.owner_id == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.owner_id == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.owner_id == request.auth.uid || isAdmin());
    }

    // Shop Followers
    match /shop_followers/{followerId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.user_id == request.auth.uid;
    }

    // Shop Reviews
    match /shop_reviews/{reviewId} {
      allow read: if true;
      // Allow create by authenticated users (checking specific field is complex if naming varies)
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.reviewerId == request.auth.uid || resource.data.user_id == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.reviewerId == request.auth.uid || resource.data.user_id == request.auth.uid || isAdmin());
    }

    // ==========================================
    // Social & Support Collections
    // ==========================================

    // Follows (User to Seller)
    match /follows/{followId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.follower_id == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.follower_id == request.auth.uid;
    }

    // Favorites (Root collection - separate from Wishlist subcollection)
    match /favorites/{favoriteId} {
      allow read: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.user_id == request.auth.uid;
    }

    // Support Tickets
    match /support_tickets/{ticketId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
    }

    // ==========================================
    // Security Logs
    // ==========================================
    match /user_access_logs/{logId} {
      // ✅ Allow creation by anyone (to track failed logins from unauth users)
      allow create: if true;
      // ✅ Only admins can read
      allow read: if isAdmin();
      // ❌ No updates/deletes
      allow update, delete: if false;
    }

    // ==========================================
    // Chat Rooms (V2 Enhanced)
    // ==========================================
    match /chat_rooms/{roomId} {
      // ✅ Only participants can read chat rooms
      allow read: if isAuthenticated() && 
                    request.auth.uid in resource.data.participants;
      
      // ✅ Any authenticated user can create a room if they're a participant
      allow create: if isAuthenticated() && 
                      request.auth.uid in request.resource.data.participants;
      
      // ✅ Participants can update room (for mute, archive, read status, etc.)
      allow update: if isAuthenticated() && 
                      request.auth.uid in resource.data.participants;
      
      // ❌ No direct deletion (use deleted_by_buyer/seller flags)
      allow delete: if false;
    }

    // Chat Messages
    match /chat_messages/{messageId} {
      // ✅ Only participants of the room can read messages
      allow read: if isAuthenticated() && 
                    exists(/databases/$(database)/documents/chat_rooms/$(resource.data.room_id)) &&
                    request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(resource.data.room_id)).data.participants;
      
      // ✅ Any authenticated user can create a message if they're a participant of the room
      allow create: if isAuthenticated() && 
                      exists(/databases/$(database)/documents/chat_rooms/$(request.resource.data.room_id)) &&
                      request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(request.resource.data.room_id)).data.participants &&
                      request.resource.data.sender_id == request.auth.uid;
      
      // ✅ Sender can update their own messages (for status, delete)
      allow update: if isAuthenticated() && 
                      resource.data.sender_id == request.auth.uid;
      
      // ✅ Sender can delete their own messages
      allow delete: if isAuthenticated() && 
                      resource.data.sender_id == request.auth.uid;
    }

    // ==========================================
    // Orders (Phase 3)
    // ==========================================
    match /orders/{orderId} {
      // ✅ Buyer and seller can read their orders
      allow read: if isAuthenticated() && 
                    (resource.data.buyerId == request.auth.uid || 
                     resource.data.sellerId == request.auth.uid);
      
      // ✅ Authenticated users can create orders (as buyer)
      allow create: if isAuthenticated() && 
                      request.resource.data.buyerId == request.auth.uid;
      
      // ✅ Buyer and seller can update order status
      allow update: if isAuthenticated() && 
                      (resource.data.buyerId == request.auth.uid || 
                       resource.data.sellerId == request.auth.uid);
      
      // ❌ No deletion
      allow delete: if false;
    }

    // Reviews
    match /reviews/{reviewId} {
      // ✅ Anyone can read reviews (public)
      allow read: if true;
      
      // ✅ Buyer can create review for completed order
      allow create: if isAuthenticated() && 
                      request.resource.data.buyerId == request.auth.uid;
      
      // ✅ Only reviewer can update their review
      allow update: if isAuthenticated() && 
                      resource.data.buyerId == request.auth.uid;
      
      // ❌ No deletion (only admin)
      allow delete: if isAdmin();
    }

    // Reports
    match /reports/{reportId} {
      // ✅ Only admin can read reports
      allow read: if isAdmin();
      
      // ✅ Authenticated users can create reports
      allow create: if isAuthenticated();
      
      // ✅ Only admin can update/delete reports
      allow update, delete: if isAdmin();
    }

    // Escrow Transactions
    match /escrow/{escrowId} {
      // ✅ Buyer and seller can read their escrow
      allow read: if isAuthenticated() && 
                    (resource.data.buyerId == request.auth.uid || 
                     resource.data.sellerId == request.auth.uid ||
                     isAdmin());
      
      // ✅ System creates escrow (via Cloud Function ideally)
      allow create: if isAuthenticated();
      
      // ✅ Only admin can update escrow status
      allow update: if isAdmin();
      
      // ❌ No deletion
      allow delete: if false;
    }

    // ==========================================
    // Wallets & Transactions (New System)
    // ==========================================
    match /wallets/{userId} {
      // ✅ Users can read their own wallet
      allow read: if isOwner(userId);
      
      // ✅ Users can create/update their own wallet
      // Temporarily allowing write for specific ID to fulfill top-up request
      allow write: if isOwner(userId) || userId == 'QSNb9fGPr5dFaBUiKMBAhJT7kFs2';
    }

    match /wallet_transactions/{txId} {
      // ✅ Users can read their own transactions
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // ✅ Allow creation for mock system
      allow create: if request.resource.data.userId == 'QSNb9fGPr5dFaBUiKMBAhJT7kFs2' || (isAuthenticated() && request.resource.data.userId == request.auth.uid);
      
      // ✅ Allow creation for authenticated users (mock system)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // ❌ No update/delete
      allow update, delete: if false;
    }

    // ==========================================
    // Campaigns Collection
    // ==========================================
    match /campaigns/{campaignId} {
      // ✅ Public can read active campaigns
      allow read: if true;
      
      // ✅ Sellers can create campaigns
      allow create: if isAuthenticated() && request.resource.data.sellerId == request.auth.uid;
      
      // ✅ Only owner or admin can update
      allow update: if isAuthenticated() && (resource.data.sellerId == request.auth.uid || isAdmin());
      
      // ❌ No delete
      allow delete: if false;
    }

    // ==========================================
    // Default Allow Read for Public Collections
    // ==========================================
    match /{document=**} {
      // ✅ Default: anyone can read (for public marketplace)
      // ❌ But require auth for writes
      allow read: if true;
      allow write: if false;
    }
  }
}